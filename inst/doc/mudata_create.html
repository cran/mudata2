<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Dewey Dunnington" />

<meta name="date" content="2018-08-19" />

<title>Creating mudata objects</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Creating mudata objects</h1>
<h4 class="author"><em>Dewey Dunnington</em></h4>
<h4 class="date"><em>2018-08-19</em></h4>



<p>As demonstrated in <code>vignette(&quot;mudata&quot;, package = &quot;mudata2&quot;)</code>, mudata objects are easy to use and have a quick data-to-analysis time. In contrast, getting data into the format takes a little more time, and requires some familiarity with <strong>dplyr</strong> and <strong>tidyr</strong>. This process is essentially the data cleaning step, except that instead of discarding all the information that you don’t need (or won’t fit in the output data structure), you can keep almost everything, possibly adding some documentation that didn’t previously exist. This is a front-end investment of time that will make subsequent users of the data better informed about how and why the data were collected in the first place.</p>
<p>(Mostly) universal data (mudata) objects are created using the <code>mudata()</code> function, which at minimum takes a data frame/tibble with one row per measurement. As an example, I’ll use the data table from the <code>ns_climate</code> dataset:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(mudata2)
ns_climate <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tbl_data</span>()</code></pre></div>
<pre><code>## # A tibble: 115,541 x 7
##    dataset           location     param   date       value flag  flag_text
##    &lt;chr&gt;             &lt;chr&gt;        &lt;chr&gt;   &lt;date&gt;     &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;    
##  1 ecclimate_monthly SABLE ISLAN… mean_m… 1897-01-01  NA   M     Missing  
##  2 ecclimate_monthly SABLE ISLAN… mean_m… 1897-02-01  NA   M     Missing  
##  3 ecclimate_monthly SABLE ISLAN… mean_m… 1897-03-01  NA   M     Missing  
##  4 ecclimate_monthly SABLE ISLAN… mean_m… 1897-04-01  NA   M     Missing  
##  5 ecclimate_monthly SABLE ISLAN… mean_m… 1897-05-01  NA   M     Missing  
##  6 ecclimate_monthly SABLE ISLAN… mean_m… 1897-06-01  NA   M     Missing  
##  7 ecclimate_monthly SABLE ISLAN… mean_m… 1897-07-01  NA   M     Missing  
##  8 ecclimate_monthly SABLE ISLAN… mean_m… 1897-08-01  NA   M     Missing  
##  9 ecclimate_monthly SABLE ISLAN… mean_m… 1897-09-01  NA   M     Missing  
## 10 ecclimate_monthly SABLE ISLAN… mean_m… 1897-10-01  12.2 &lt;NA&gt;  &lt;NA&gt;     
## # ... with 115,531 more rows</code></pre>
<p>At minimum the data table must contain the columns <code>param</code> and <code>value</code>. The <code>param</code> column contains the identifier of the measured parameter (a character vector), and the <code>value</code> column contains the value of the measurement (there is no restriction on what type this is except that it has to be the same type for all parameters; see below for ways around this). To represent measurements at more than one location, you can include a location column with location identifiers (a character vector). To represent measurements at more than one point in time, you can include a column between <code>param</code> and <code>value</code> specifying at what time the measurement was taken. To the right of the <code>value</code> column, you can include any columns needed to add context to <code>value</code> (I typically use this for uncertainty, detection limits, and comments on a particular measurement).</p>
<p>In the context of <code>ns_climate</code>, the <code>location</code> column contains station names like “SABLE ISLAND”, the <code>param</code> column contains measurement names like “mean_max_temp”, and the point in time the measurement was taken is included in the <code>date</code> column. To the right of the <code>value</code> column, there are two columns that add extra “flag” information provided by Environment Canada. These data are distributed with Environment Canada climate downloads, but are often discarded because the 12 paired columns in the standard wide data format in which they are distributed are a bit unwieldy.</p>
<p>In general, the steps to create a mudata object are:</p>
<ul>
<li><strong>Create the data table</strong> using the data wrangling tools in the <strong>tidyverse</strong>.</li>
<li><strong>Create the object</strong> using <code>mudata()</code>.</li>
<li><strong>Add the metadata</strong> using <code>update_locations()</code>, <code>update_params()</code>, and <code>update_datasets()</code>.</li>
<li><strong>Update the columns table</strong> using <code>update_columns_table()</code> to include the metadata columns you just added in the columns table.</li>
<li><strong>Add column descriptions</strong> using <code>update_columns()</code>.</li>
<li><strong>Write the object to disk</strong> using <code>write_mudata()</code>.</li>
</ul>
<div id="creating-the-data-table" class="section level2">
<h2>Creating the data table</h2>
<p>As an example, I’m going to use a small subset of the sediment chemistry data that I work with on a regular basis. Instead of being aligned along the “time” or “date” axis, these data are aligned along the “depth” axis, or in other words, the columns that identify each measurement are <code>location</code> (the sediment sample ID), <code>param</code> (the chemical that was measured), and <code>depth</code> (the position in the sediment sample). This dataset is included in the package as <code>pocmaj</code> and <code>pocmajsum</code>.</p>
<p>I’ll use the <strong>tidyverse</strong> for data wrangling, and the <code>pocmaj</code> and <code>pocmajsum</code> datasets to illustrate how to get from common data formats to the parameter-long, one-row-per-measurement data needed by the <code>mudata()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">data</span>(<span class="st">&quot;pocmaj&quot;</span>)
<span class="kw">data</span>(<span class="st">&quot;pocmajsum&quot;</span>)</code></pre></div>
<div id="case-1-wide-summarised-data" class="section level3">
<h3>Case 1: Wide, summarised data</h3>
<p>Parameter-wide, summarised data is the probably the most common form of data. If you’ve gotten this far, there is a good chance that you have data like this hanging around somewhere:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pocmajwide &lt;-<span class="st"> </span>pocmajsum <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(core, depth, Ca, V, Ti)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">core</th>
<th align="right">depth</th>
<th align="right">Ca</th>
<th align="right">V</th>
<th align="right">Ti</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">MAJ-1</td>
<td align="right">0</td>
<td align="right">1885</td>
<td align="right">78</td>
<td align="right">2370</td>
</tr>
<tr class="even">
<td align="left">MAJ-1</td>
<td align="right">1</td>
<td align="right">1418</td>
<td align="right">70</td>
<td align="right">2409</td>
</tr>
<tr class="odd">
<td align="left">MAJ-1</td>
<td align="right">2</td>
<td align="right">1550</td>
<td align="right">70</td>
<td align="right">2376</td>
</tr>
<tr class="even">
<td align="left">MAJ-1</td>
<td align="right">3</td>
<td align="right">1448</td>
<td align="right">64</td>
<td align="right">2485</td>
</tr>
<tr class="odd">
<td align="left">MAJ-1</td>
<td align="right">4</td>
<td align="right">1247</td>
<td align="right">57</td>
<td align="right">2414</td>
</tr>
<tr class="even">
<td align="left">MAJ-1</td>
<td align="right">5</td>
<td align="right">1412</td>
<td align="right">81</td>
<td align="right">1897</td>
</tr>
<tr class="odd">
<td align="left">POC-2</td>
<td align="right">0</td>
<td align="right">1622</td>
<td align="right">33</td>
<td align="right">2038</td>
</tr>
<tr class="even">
<td align="left">POC-2</td>
<td align="right">1</td>
<td align="right">1488</td>
<td align="right">36</td>
<td align="right">2016</td>
</tr>
<tr class="odd">
<td align="left">POC-2</td>
<td align="right">2</td>
<td align="right">2416</td>
<td align="right">79</td>
<td align="right">3270</td>
</tr>
<tr class="even">
<td align="left">POC-2</td>
<td align="right">3</td>
<td align="right">2253</td>
<td align="right">79</td>
<td align="right">3197</td>
</tr>
<tr class="odd">
<td align="left">POC-2</td>
<td align="right">4</td>
<td align="right">2372</td>
<td align="right">87</td>
<td align="right">3536</td>
</tr>
<tr class="even">
<td align="left">POC-2</td>
<td align="right">5</td>
<td align="right">2635</td>
<td align="right">87</td>
<td align="right">3890</td>
</tr>
</tbody>
</table>
<p>This is a small subset of paleolimnological data for two sediment cores near Halifax, Nova Scotia. The data is a multi-parameter spatiotemporal dataset because it contains multiple parameters (calcium, titanium, and vanadium concentrations) measured along a common axis (depth in the sediment core) at discrete locations (cores named MAJ-1 and POC-2). Currently, our columns are not named properly: for the mudata format the terminology is ‘location’ not ‘core’. The <code>rename()</code> function is the easiest way to do this.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pocmajwide &lt;-<span class="st"> </span>pocmajwide <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">location =</span> core)</code></pre></div>
<p>Finally, we need to get the data into a parameter-long format, with a column named <code>param</code> and our actual values in a single column called <code>value</code>. This can be done using the <code>gather()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pocmajlong &lt;-<span class="st"> </span>pocmajwide <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gather</span>(Ca, Ti, V, <span class="dt">key =</span> <span class="st">&quot;param&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;value&quot;</span>)</code></pre></div>
<p>The (first six rows of the) data now look like this:</p>
<table>
<thead>
<tr class="header">
<th align="left">location</th>
<th align="right">depth</th>
<th align="left">param</th>
<th align="right">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">MAJ-1</td>
<td align="right">0</td>
<td align="left">Ca</td>
<td align="right">1885</td>
</tr>
<tr class="even">
<td align="left">MAJ-1</td>
<td align="right">1</td>
<td align="left">Ca</td>
<td align="right">1418</td>
</tr>
<tr class="odd">
<td align="left">MAJ-1</td>
<td align="right">2</td>
<td align="left">Ca</td>
<td align="right">1550</td>
</tr>
<tr class="even">
<td align="left">MAJ-1</td>
<td align="right">3</td>
<td align="left">Ca</td>
<td align="right">1448</td>
</tr>
<tr class="odd">
<td align="left">MAJ-1</td>
<td align="right">4</td>
<td align="left">Ca</td>
<td align="right">1247</td>
</tr>
<tr class="even">
<td align="left">MAJ-1</td>
<td align="right">5</td>
<td align="left">Ca</td>
<td align="right">1412</td>
</tr>
</tbody>
</table>
<p>The last important thing to consider is the axis on which the data are aligned. This sounds complicated but isn’t: these axes are the same axes you might use to plot the data, in this case <code>depth</code>. The <code>mudata()</code> constructor needs to know which column this is, either by explicitly passing <code>x_columns = &quot;depth&quot;</code> or by placing the column between “param” and “value”. In most cases (like this one) it can be guessed (you’ll see a message telling you which columns were assigned this value).</p>
<p>Now the data is ready to be put into the <code>mudata()</code> constructor. If it isn’t, the constructor will throw an error telling you how to fix the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">md &lt;-<span class="st"> </span><span class="kw">mudata</span>(pocmajlong)</code></pre></div>
<pre><code>## Guessing x columns: depth</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">md</code></pre></div>
<pre><code>## A mudata object aligned along &quot;depth&quot;
##   distinct_datasets():  &quot;default&quot;
##   distinct_locations(): &quot;MAJ-1&quot;, &quot;POC-2&quot;
##   distinct_params():    &quot;Ca&quot;, &quot;Ti&quot;, &quot;V&quot;
##   src_tbls():           &quot;data&quot;, &quot;locations&quot; ... and 3 more
## 
## tbl_data() %&gt;% head():
## # A tibble: 6 x 5
##   dataset location param depth value
##   &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;int&gt; &lt;dbl&gt;
## 1 default MAJ-1    Ca        0  1885
## 2 default MAJ-1    Ca        1  1418
## 3 default MAJ-1    Ca        2  1550
## 4 default MAJ-1    Ca        3  1448
## 5 default MAJ-1    Ca        4  1247
## 6 default MAJ-1    Ca        5  1412</code></pre>
</div>
<div id="case-2-wide-summarised-data-with-uncertainty" class="section level3">
<h3>Case 2: Wide, summarised data with uncertainty</h3>
<p>Data is often output in a format similar to the format above, but with uncertainty information in paired columns. Data from an ICP-MS, for example is often in this format, with the concentration and a +/- column next to it. One of the advantages of a long format is the ability to include this information in a way that makes plotting with error bars easier. The <code>pocmajsum</code> dataset is a version of the dataset described above, but with standard deviation values in paired columns with the value itself.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pocmajsum</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">core</th>
<th align="right">depth</th>
<th align="right">Ca</th>
<th align="right">Ca_sd</th>
<th align="right">Ti</th>
<th align="right">Ti_sd</th>
<th align="right">V</th>
<th align="right">V_sd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">MAJ-1</td>
<td align="right">0</td>
<td align="right">1885</td>
<td align="right">452</td>
<td align="right">2370</td>
<td align="right">401</td>
<td align="right">78</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="left">MAJ-1</td>
<td align="right">1</td>
<td align="right">1418</td>
<td align="right">NA</td>
<td align="right">2409</td>
<td align="right">NA</td>
<td align="right">70</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">MAJ-1</td>
<td align="right">2</td>
<td align="right">1550</td>
<td align="right">NA</td>
<td align="right">2376</td>
<td align="right">NA</td>
<td align="right">70</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">MAJ-1</td>
<td align="right">3</td>
<td align="right">1448</td>
<td align="right">NA</td>
<td align="right">2485</td>
<td align="right">NA</td>
<td align="right">64</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">MAJ-1</td>
<td align="right">4</td>
<td align="right">1247</td>
<td align="right">NA</td>
<td align="right">2414</td>
<td align="right">NA</td>
<td align="right">57</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">MAJ-1</td>
<td align="right">5</td>
<td align="right">1412</td>
<td align="right">126</td>
<td align="right">1897</td>
<td align="right">81</td>
<td align="right">81</td>
<td align="right">12</td>
</tr>
<tr class="odd">
<td align="left">POC-2</td>
<td align="right">0</td>
<td align="right">1622</td>
<td align="right">509</td>
<td align="right">2038</td>
<td align="right">608</td>
<td align="right">33</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">POC-2</td>
<td align="right">1</td>
<td align="right">1488</td>
<td align="right">NA</td>
<td align="right">2016</td>
<td align="right">NA</td>
<td align="right">36</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">POC-2</td>
<td align="right">2</td>
<td align="right">2416</td>
<td align="right">NA</td>
<td align="right">3270</td>
<td align="right">NA</td>
<td align="right">79</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">POC-2</td>
<td align="right">3</td>
<td align="right">2253</td>
<td align="right">NA</td>
<td align="right">3197</td>
<td align="right">NA</td>
<td align="right">79</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">POC-2</td>
<td align="right">4</td>
<td align="right">2372</td>
<td align="right">NA</td>
<td align="right">3536</td>
<td align="right">NA</td>
<td align="right">87</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">POC-2</td>
<td align="right">5</td>
<td align="right">2635</td>
<td align="right">143</td>
<td align="right">3890</td>
<td align="right">45</td>
<td align="right">87</td>
<td align="right">8</td>
</tr>
</tbody>
</table>
<p>As above, we need to rename the <code>core</code> column to <code>location</code> using the <code>rename()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pocmajwide &lt;-<span class="st"> </span>pocmajsum <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">location =</span> core)</code></pre></div>
<p>Then (also as above), we need to <code>gather()</code> the data to get it into long form. Because we have paired columns, this is handled by a different function (from the mudata package) called <code>parallel_melt()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pocmajlong &lt;-<span class="st"> </span><span class="kw">parallel_gather</span>(pocmajwide, <span class="dt">key =</span> <span class="st">&quot;param&quot;</span>,
                              <span class="dt">value =</span> <span class="kw">c</span>(Ca, Ti, V), 
                              <span class="dt">sd =</span> <span class="kw">c</span>(Ca_sd, Ti_sd, V_sd))</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">location</th>
<th align="right">depth</th>
<th align="left">param</th>
<th align="right">value</th>
<th align="right">sd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">MAJ-1</td>
<td align="right">0</td>
<td align="left">Ca</td>
<td align="right">1885</td>
<td align="right">452</td>
</tr>
<tr class="even">
<td align="left">MAJ-1</td>
<td align="right">1</td>
<td align="left">Ca</td>
<td align="right">1418</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">MAJ-1</td>
<td align="right">2</td>
<td align="left">Ca</td>
<td align="right">1550</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">MAJ-1</td>
<td align="right">3</td>
<td align="left">Ca</td>
<td align="right">1448</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">MAJ-1</td>
<td align="right">4</td>
<td align="left">Ca</td>
<td align="right">1247</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">MAJ-1</td>
<td align="right">5</td>
<td align="left">Ca</td>
<td align="right">1412</td>
<td align="right">126</td>
</tr>
</tbody>
</table>
<p>The data is now ready to be fed to the <code>mudata()</code> constructor:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">md &lt;-<span class="st"> </span><span class="kw">mudata</span>(pocmajlong)</code></pre></div>
<pre><code>## Guessing x columns: depth</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">md</code></pre></div>
<pre><code>## A mudata object aligned along &quot;depth&quot;
##   distinct_datasets():  &quot;default&quot;
##   distinct_locations(): &quot;MAJ-1&quot;, &quot;POC-2&quot;
##   distinct_params():    &quot;Ca&quot;, &quot;Ti&quot;, &quot;V&quot;
##   src_tbls():           &quot;data&quot;, &quot;locations&quot; ... and 3 more
## 
## tbl_data() %&gt;% head():
## # A tibble: 6 x 6
##   dataset location param depth value    sd
##   &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 default MAJ-1    Ca        0  1885   452
## 2 default MAJ-1    Ca        1  1418    NA
## 3 default MAJ-1    Ca        2  1550    NA
## 4 default MAJ-1    Ca        3  1448    NA
## 5 default MAJ-1    Ca        4  1247    NA
## 6 default MAJ-1    Ca        5  1412   126</code></pre>
</div>
</div>
<div id="adding-metadata" class="section level2">
<h2>Adding metadata</h2>
<p>When mudata objects are created using only the data table, the package creates the necessary tables for parameter, location, and dataset metadata (if you have these tables prepared already, you can pass them as the arguments <code>locations</code>, <code>params</code>, and <code>datasets</code>). These tables provide a place to put metadata, but doesn’t create any by default. This data is usually needed later, and including it in the object at the point of creation avoids others or future you from scratching their (your) heads with the question “where <em>did</em> core POC-2 come from anyway…”. To do this, you can update the tables using <code>update_params()</code>, <code>update_locations()</code>, and <code>update_datasets()</code>. The first argument of these functions is a vector of identifiers to update (or all of them if not specified), followed by key/value pairs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># default parameter table</span>
md <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tbl_params</span>()</code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   dataset param
##   &lt;chr&gt;   &lt;chr&gt;
## 1 default Ca   
## 2 default Ti   
## 3 default V</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># parameter table with metadata</span>
md <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_params</span>(<span class="dt">method =</span> <span class="st">&quot;Portable XRF Spectrometer (Olympus X-50)&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tbl_params</span>()</code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   dataset param method                                  
##   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;                                   
## 1 default Ca    Portable XRF Spectrometer (Olympus X-50)
## 2 default Ti    Portable XRF Spectrometer (Olympus X-50)
## 3 default V     Portable XRF Spectrometer (Olympus X-50)</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># default location table</span>
md <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tbl_locations</span>()</code></pre></div>
<pre><code>## # A tibble: 2 x 2
##   dataset location
##   &lt;chr&gt;   &lt;chr&gt;   
## 1 default MAJ-1   
## 2 default POC-2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># location table with metadata</span>
md <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_locations</span>(<span class="st">&quot;MAJ-1&quot;</span>, <span class="dt">latitude =</span> <span class="op">-</span><span class="fl">64.298</span>, <span class="dt">longitude =</span> <span class="fl">44.819</span>,
                   <span class="dt">lake =</span> <span class="st">&quot;Lake Major&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_locations</span>(<span class="st">&quot;POC-2&quot;</span>, <span class="dt">latitude =</span> <span class="op">-</span><span class="fl">65.985</span>, <span class="dt">longitude =</span> <span class="fl">44.913</span>,
                   <span class="dt">lake =</span> <span class="st">&quot;Pockwock Lake&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tbl_locations</span>()</code></pre></div>
<pre><code>## # A tibble: 2 x 5
##   dataset location latitude longitude lake         
##   &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;        
## 1 default MAJ-1       -64.3      44.8 Lake Major   
## 2 default POC-2       -66.0      44.9 Pockwock Lake</code></pre>
<p>The concept of a “dataset” is intended to refer to the source of a dataset, but could be anything that applies to data, params, and locations labelled with that dataset. In this case it would make sense to add that the source data is the <strong>mudata2</strong> package. The default name is “default”, which you can change in the <code>mudata()</code> function by passing <code>dataset_id</code> or by using <code>rename_datasets()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># default datasets table</span>
md <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tbl_datasets</span>()</code></pre></div>
<pre><code>## # A tibble: 1 x 1
##   dataset
##   &lt;chr&gt;  
## 1 default</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># datasets table with metadata</span>
md <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_datasets</span>(<span class="dt">source =</span> <span class="st">&quot;R package mudata2, version 1.0.0&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tbl_datasets</span>()</code></pre></div>
<pre><code>## # A tibble: 1 x 2
##   dataset source                          
##   &lt;chr&gt;   &lt;chr&gt;                           
## 1 default R package mudata2, version 1.0.0</code></pre>
<p>All together, the param/location/dataset documentation looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">md_doc &lt;-<span class="st"> </span>md <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_params</span>(<span class="dt">method =</span> <span class="st">&quot;Portable XRF Spectrometer (Olympus X-50)&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_locations</span>(<span class="st">&quot;MAJ-1&quot;</span>, <span class="dt">latitude =</span> <span class="op">-</span><span class="fl">63.486</span>, <span class="dt">longitude =</span> <span class="fl">44.732</span>,
                   <span class="dt">lake =</span> <span class="st">&quot;Lake Major&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_locations</span>(<span class="st">&quot;POC-2&quot;</span>, <span class="dt">latitude =</span> <span class="op">-</span><span class="fl">63.839</span>, <span class="dt">longitude =</span> <span class="fl">44.794</span>,
                   <span class="dt">lake =</span> <span class="st">&quot;Pockwock Lake&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_datasets</span>(<span class="dt">source =</span> <span class="st">&quot;R package mudata2, version 1.0.0&quot;</span>)</code></pre></div>
</div>
<div id="adding-column-metadata" class="section level2">
<h2>Adding column metadata</h2>
<p>The <code>mudata()</code> constructor automatically generates a barebones columns table (<code>tbl_columns()</code>), but since the creation of the object we have created new columns that need documentation. Thus, before documenting columns using <code>update_columns()</code>, it is necessary to call <code>update_columns_table()</code> to synchronize the columns table with the object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">md_doc &lt;-<span class="st"> </span>md_doc <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_columns_table</span>()</code></pre></div>
<p>Then, you can use <code>update_columns()</code> to add information about various columns to the object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># default columns table</span>
md_doc <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tbl_columns</span>()</code></pre></div>
<pre><code>## # A tibble: 16 x 4
##    dataset table     column    type     
##    &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;    
##  1 default data      dataset   character
##  2 default data      location  character
##  3 default data      param     character
##  4 default data      depth     integer  
##  5 default data      value     double   
##  6 default data      sd        double   
##  7 default locations dataset   character
##  8 default locations location  character
##  9 default locations latitude  double   
## 10 default locations longitude double   
## 11 default locations lake      character
## 12 default params    dataset   character
## 13 default params    param     character
## 14 default params    method    character
## 15 default datasets  dataset   character
## 16 default datasets  source    character</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># columns with metadata </span>
md_doc <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_columns</span>(<span class="st">&quot;depth&quot;</span>, <span class="dt">description =</span> <span class="st">&quot;Depth in sediment core (cm)&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_columns</span>(<span class="st">&quot;sd&quot;</span>, <span class="dt">description =</span> <span class="st">&quot;Standard deviation uncertainty of n=3 values&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tbl_columns</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(dataset, table, column, description, type)</code></pre></div>
<pre><code>## # A tibble: 16 x 5
##    dataset table     column    description                         type   
##    &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;                               &lt;chr&gt;  
##  1 default data      dataset   &lt;NA&gt;                                charac…
##  2 default data      location  &lt;NA&gt;                                charac…
##  3 default data      param     &lt;NA&gt;                                charac…
##  4 default data      depth     Depth in sediment core (cm)         integer
##  5 default data      value     &lt;NA&gt;                                double 
##  6 default data      sd        Standard deviation uncertainty of … double 
##  7 default locations dataset   &lt;NA&gt;                                charac…
##  8 default locations location  &lt;NA&gt;                                charac…
##  9 default locations latitude  &lt;NA&gt;                                double 
## 10 default locations longitude &lt;NA&gt;                                double 
## 11 default locations lake      &lt;NA&gt;                                charac…
## 12 default params    dataset   &lt;NA&gt;                                charac…
## 13 default params    param     &lt;NA&gt;                                charac…
## 14 default params    method    &lt;NA&gt;                                charac…
## 15 default datasets  dataset   &lt;NA&gt;                                charac…
## 16 default datasets  source    &lt;NA&gt;                                charac…</code></pre>
<p>You’ll notice there’s a <code>type</code> column that is also automatically generated, which I suggest that you don’t mess with (it will get overwritten by default before you write the object to disk). If something is the wrong type, you should use the <code>mudate_*()</code> family of functions to fix the column type, then run <code>update_columns_table()</code> again. From the top, the documentation looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">md_doc &lt;-<span class="st"> </span>md <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_params</span>(<span class="dt">method =</span> <span class="st">&quot;Portable XRF Spectrometer (Olympus X-50)&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_locations</span>(<span class="st">&quot;MAJ-1&quot;</span>, <span class="dt">latitude =</span> <span class="op">-</span><span class="fl">63.486</span>, <span class="dt">longitude =</span> <span class="fl">44.732</span>,
                   <span class="dt">lake =</span> <span class="st">&quot;Lake Major&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_locations</span>(<span class="st">&quot;POC-2&quot;</span>, <span class="dt">latitude =</span> <span class="op">-</span><span class="fl">63.839</span>, <span class="dt">longitude =</span> <span class="fl">44.794</span>,
                   <span class="dt">lake =</span> <span class="st">&quot;Pockwock Lake&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_datasets</span>(<span class="dt">source =</span> <span class="st">&quot;R package mudata2, version 1.0.0&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_columns_table</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_columns</span>(<span class="st">&quot;depth&quot;</span>, <span class="dt">description =</span> <span class="st">&quot;Depth in sediment core (cm)&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">update_columns</span>(<span class="st">&quot;sd&quot;</span>, <span class="dt">description =</span> <span class="st">&quot;Standard deviation uncertainty of n=3 values&quot;</span>)</code></pre></div>
</div>
<div id="writing-mudata-objects" class="section level2">
<h2>Writing mudata objects</h2>
<p>There are three possible formats to which mudata objects can be read: A directory of CSV files (one per table), a ZIP archive of the directory format, and a JSON encoding of the tables. You can write all of them using <code>write_mudata()</code> with a <code>filename</code> of the appropriate extension:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># write to directory</span>
<span class="kw">write_mudata</span>(poc_maj, <span class="st">&quot;poc_maj.mudata&quot;</span>)
<span class="co"># write to ZIP</span>
<span class="kw">write_mudata</span>(poc_maj, <span class="st">&quot;poc_maj.mudata.zip&quot;</span>)
<span class="co"># write to JSON</span>
<span class="kw">write_mudata</span>(poc_maj, <span class="st">&quot;poc_maj.mudata.json&quot;</span>)</code></pre></div>
<p>Then, you can read the file/directory using <code>read_mudata()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># read from directory</span>
<span class="kw">read_mudata</span>(<span class="st">&quot;poc_maj.mudata&quot;</span>)
<span class="co"># read from ZIP</span>
<span class="kw">read_mudata</span>(<span class="st">&quot;poc_maj.mudata.zip&quot;</span>)
<span class="co"># read from JSON</span>
<span class="kw">read_mudata</span>(<span class="st">&quot;poc_maj.mudata.json&quot;</span>)</code></pre></div>
<p>The convention of using “.mudata.*&quot; isn’t necessary, but seems like a good idea to point potential data users in the direction of this package.</p>
</div>
<div id="more-information" class="section level2">
<h2>More information</h2>
<p>That is most of what there is to creating mudata objects. For more reading, I suggest looking at the documentation for <code>?mudata</code>, <code>?update_locations</code>, <code>?mudata_prepare_column</code>, and <code>?read_mudata</code>.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
